var gui={},flickrBlue="#006add",flickrPink="#ff1981",initialRaster=9,getUser,scrapeData,buildNetwork,eigenValues,trainSOM,assignments,centralities,download,sequence,sequenceCount=0;gui.data={};gui.locks={canDrag:!0,canClick:!0,canChangeTags:!0};gui.data.selectedClusters=[];gui.data.selectedTags=[];gui.data.photosForTags={};gui.data.selectedPhotoIds={};gui.data.selectedPhotoThumbs=[];gui.data.selectedPhotoLinks=[];gui.data.oldCount=0;
function analysisStage(b,c,f,a){this.execute=function(){var a,d;a=$("#"+this.label);a.css("background-color","orange");d=this;$.post("clustrr/"+this.label,this.send(),function(g){"ok"===g.status&&(a.css("background-color",flickrBlue),d.success(g),nextStage());"fail"===g.status&&a.css("background-color",flickrPink)})};this.success=void 0===a?genericSuccess:a;this.send=void 0===f?genericSend:f;this.label=b;this.caption=c}function genericSuccess(b){}function userSuccess(b){gui.data.nsid=b.nsid}
function downloadSuccess(b){function c(){void 0===gui.eigenplot&&(gui.eigenplot=new eigenplot("eigenplot",295,245),gui.eigenplot.create());gui.eigenplot.data=b.eigenvalues.map(function(b,a){return{x:a+1,y:parseFloat(b)}});gui.eigenplot.setScales();gui.eigenplot.redraw();gui.eigenplot.replot()}$.map("members tags centralities counts tagsToPhotos photosToThumbs photosToLinks".split(" "),function(c,a){gui.data[c]=b[c]});$("#progress2").slideUp(400,function(){c();void 0!==gui.som&&(delete gui.som,d3.select("#som-svg").remove(),
$("#som").off("click"));gui.som=new som("som",245,245,b.umatrix,b.borders,b.clusters);gui.som.create();gui.som.outline(initialRaster);gui.som.assignClusters(initialRaster);void 0===gui.blocks&&(gui.blocks=new clusterGraph("clustergraph",245,245),gui.blocks.create());gui.blocks.clusterData=b.blockdiagonal;gui.blocks.frameSizeX=b.ntags;gui.blocks.frameSizeY=b.ntags;gui.blocks.loadImage(b.blockdiagonalurl,initialRaster);gui.blocks.raster(initialRaster);"undefined"===typeof gui.wordcloud&&(gui.wordcloud=
new wordCloud("wordcloud",780,200),gui.wordcloud.create());gui.wordcloud.clear();d3.select("#wordcloud").style("opacity",1);void 0===gui.photocounter&&(gui.photocounter=new photoCounter("wordcloud"),gui.photocounter.create());void 0===gui.photoMatrix&&(gui.photoMatrix=new photoMatrix("photoMatrix",3,5),gui.photoMatrix.create());d3.selectAll(".thumbnail_element").remove()})}function genericSend(){return{}}function userSend(){var b=$("#username");return{name:b.val()||b.attr("placeholder")}}
function nextStage(){sequenceCount<sequence.length&&(sequence[sequenceCount].execute(),sequenceCount+=1)}getUser=new analysisStage("getuser",["Find","User"],userSend,userSuccess);scrapeData=new analysisStage("scrape",["Scrape","Data"]);buildNetwork=new analysisStage("buildnetwork",["Build","Network"]);eigenValues=new analysisStage("eigenvalues",["Calculate","Spectrum"]);trainSOM=new analysisStage("trainsom",["Train","SOMs"]);assignments=new analysisStage("assignments",["Assign","Clusters"]);
centralities=new analysisStage("centralities",["Calculate","Centrality"]);download=new analysisStage("download",["Download","Data"],genericSend,downloadSuccess);sequence=[getUser,scrapeData,buildNetwork,eigenValues,trainSOM,assignments,centralities,download];
function wordCloud(b,c,f){this.where=b;this.width=c;this.height=f;this.cachedVocabulary={};this.color1=d3.rgb(flickrBlue);this.color2=d3.rgb(flickrPink);this.interpolator=d3.interpolateRgb(this.color1,this.color2);this.create=function(){d3.select("#"+this.where).append("svg").attr("id",this.where+"-svg").attr("width",this.width).attr("height",this.height);d3.select("#"+this.where+"-svg").append("g").attr("transform","translate(0,0)").attr("id","sandbox").style("opacity",0)};this.clear=function(){d3.selectAll("#sandbox text").remove()};
this.clusterSelectDeselect=function(a){var e=[],d=[],g,b,c;if(!this.cachedVocabulary.hasOwnProperty(a)&&gui.data.members.hasOwnProperty(a)){for(g=0;g<gui.data.members[a].length;g++)b=gui.data.tags[gui.data.members[a][g]],c=this.interpolator(gui.data.centralities[a][b]/255),e.push({word:b,size:gui.data.counts[b],fill:c});this.cachedVocabulary[a]=e}for(g=0;g<gui.data.selectedClusters.length;g++)a=this.cachedVocabulary[gui.data.selectedClusters[g]],d=d.concat(a);this.drawToFit(d)};this.drawToFit=function(a){d3.select("#sandbox").style("opacity",
0);d3.select("#sandbox");var e=!0,d=1,g=5,b,c,h=g=0;if(0<a.length){for(this.clear();e;)this.redraw(a,d),d3.selectAll("#sandbox text")[0].length<a.length?e=!1:d*=2,this.clear(),g+=1;1===g?(g=8,b=1,c=0):(g=5,b=d,c=d/2);for(e=0;e<g;e++)d=(b+c)/2,this.redraw(a,d),d3.selectAll("#sandbox text")[0].length<a.length?b=d:c=d,this.clear();for(;d3.selectAll("#sandbox text")[0].length<a.length;)this.clear(),this.redraw(a,c),10<h&&this.drawToFit(a),h+=1;this.center();d3.select("#sandbox").style("opacity",1);for(e=
0;e<gui.data.selectedTags.length;e++)d3.select("#wordcloud-"+gui.data.selectedTags[e]).style("fill","orange").classed("selected",!0)}else gui.locks.canClick=!0;gui.photocounter.update()};this.center=function(){var a=d3.select("#sandbox")[0][0].getBBox(),e=d3.select("#wordcloud-svg")[0][0],d=-a.x+(e.offsetWidth-a.width)/2,a=-a.y+(e.offsetHeight-a.height)/2;d3.select("#sandbox").attr("transform","translate("+d+","+a+")")};this.redraw=function(a,e){gui.locks.canClick=!1;d3.layout.cloud().size([this.width,
this.height]).words(a.map(function(a){return{text:a.word,fill:a.fill,size:a.size*e}})).rotate(0).font("Impact").fontSize(function(a){return a.size}).on("end",function(a){d3.select("#sandbox").selectAll("text").data(a).enter().append("text").style("font-size",function(a){return a.size+"px"}).style("font-family","Impact").style("fill",function(a,e){return a.fill}).attr("text-anchor","middle").attr("transform",function(a){return"translate("+[a.x,a.y]+")rotate("+a.rotate+")"}).attr("id",function(a){return"wordcloud-"+
a.text}).attr("data-fill",function(a){return a.fill}).text(function(a){return a.text}).on("click",function(a){selectTag(a.text)});gui.locks.canClick=!0}).start()}}
function photoCounter(b){this.where=b;this.parent=d3.select("#"+this.where+"-svg");this.oldCount=0;this.create=function(){var b;this.parent.append("text").attr("id","counter-text").style("font-size","12px").style("font-family","Impact").style("fill","black").style("opacity",1).attr("x","50%").attr("y","50%").style("opacity",0).text("0").attr("text-anchor","middle").attr("alignment-baseline","central");b=d3.select("#counter-text")[0][0].getBBox().height;b=12*this.parent[0][0].offsetHeight/b;d3.select("#counter-text").style("font-size",
b+"px").style("opacity",.3)};this.update=function(){var b,f=this,a,e,d=[],g=[];b=Object.keys(gui.data.selectedPhotoIds).length||0;d3.select("#counter-text").transition().duration(300).tween("text",function(){var a=d3.interpolateRound(f.oldCount,b);return function(g){this.textContent=a(g)}}).each("end",function(){f.oldCount=b});a=Object.keys(gui.data.selectedPhotoIds);for(e=0;e<b;e++)g.push(gui.data.photosToLinks[a[e]]),d.push(gui.data.photosToThumbs[a[e]]);gui.data.selectedPhotoThumbs=d;gui.data.selectedPhotoLinks=
g}}
function som(b,c,f,a,e,d){this.where=b;this.width=c;this.height=f;this.borderColor=flickrPink;this.pixelData=a;this.borderData=e;this.borderStrings={};this.clusterData=d;this.create=function(){d3.select("#"+this.where).append("svg").attr("id",this.where+"-svg").attr("width",this.width).attr("height",this.height);d3.select("#"+this.where+"-svg").append("g").attr("id",this.where+"-rectGroup");this._precalculateOutlines();this.draw(this.pixelData)};this._buildOutlineString=function(a,e){var d="",b="",
c="",f="",u=[4,5,6,7,12,13,14,15],q=[1,3,5,7,9,11,13,15],m=[8,9,10,11,12,13,14,15],n=[2,3,6,7,10,11,14,15],k,s,r,t;for(k=0;k<a.length;k++)for(s=0;s<a[k].length;s++)r=a[k][s],0<r&&(t=",#som_row"+k+"_col"+s,-1<u.indexOf(r)&&(d+=t),-1<q.indexOf(r)&&(b+=t),-1<m.indexOf(r)&&(c+=t),-1<n.indexOf(r)&&(f+=t));this.borderStrings[e]={tops:d.slice(1),rights:b.slice(1),bottoms:c.slice(1),lefts:f.slice(1)}};this._precalculateOutlines=function(){var a;for(a=0;a<this.borderData.length;a++)this._buildOutlineString(this.borderData[a],
a.toString());delete this.borderData};this.outline=function(a){d3.selectAll("#"+this.where).selectAll(".border").style("fill-opacity",0);a=this.borderStrings[a.toString()];d3.selectAll(a.tops).selectAll(".top").style("fill-opacity",1);d3.selectAll(a.rights).selectAll(".right").style("fill-opacity",1);d3.selectAll(a.bottoms).selectAll(".bottom").style("fill-opacity",1);d3.selectAll(a.lefts).selectAll(".left").style("fill-opacity",1)};this.draw=function(a){this.scaleY=this.height/a.length;this.scaleX=
this.width/a[0].length;var e=this.scaleX-1,d=this.scaleY-1,b=this.scaleX-2,c=this.scaleY-2,f=[],u=this.borderColor,q,m,n,k;for(m=0;m<a.length;m++)for(n=0;n<a[m].length;n++)q=255-a[m][n],f.push({t:"translate("+this.scaleX*n+","+this.scaleY*m+")",id:"som_row"+m+"_col"+n,v:q,b:"rgb("+q+","+q+","+q+")"});d3.select("#"+this.where+"-rectGroup").selectAll("g").remove();d3.select("#"+this.where+"-rectGroup").selectAll("g").data(f).enter().append("g").attr("id",function(a){return a.id}).attr("transform",function(a){return a.t}).attr("data-selected",
!1).attr("data-v",function(a){return a.v}).classed("somcell",!0);k=d3.selectAll(".somcell");k.append("rect").attr("x",0).attr("y",0).attr("width",this.scaleX).attr("height",this.scaleY).attr("fill",function(a){return a.b}).attr("fill-opacity",1).classed("center",!0);$.map([{x:1,y:0,w:b,h:1,c:"border top"},{x:e,y:1,w:1,h:c,c:"border right"},{x:1,y:d,w:b,h:1,c:"border bottom"},{x:0,y:1,w:1,h:c,c:"border left"},{x:0,y:0,w:1,h:1,c:"border top left"},{x:e,y:0,w:1,h:1,c:"border top right"},{x:e,y:d,w:1,
h:1,c:"border bottom right"},{x:0,y:d,w:1,h:1,c:"border bottom left"}],function(a,e){k.append("rect").attr("x",a.x).attr("y",a.y).attr("width",a.w).attr("height",a.h).style("fill",u).style("fill-opacity",0).classed(a.c,!0)});$("#"+this.where).on("click",".somcell",this.clickCallback)};this.assignClusters=function(a){d3.selectAll(".somcell").attr("data-cluster",null);a=this.clusterData[a];var e=[],d,b,c,f;for(c=0;c<a.length;c++)for(f=0;f<a[c].length;f++)d="#som_row"+c+"_col"+f,b=a[c][f],e.push([d,
b]);$.map(e,function(a,e){$(a[0]).attr("data-cluster",a[1])})};this.clusterSelectDeselect=function(a){var e,d,b,c;d3.selectAll("[data-cluster='"+a+"']").select(".center").attr("fill",function(a){e=d3.select(this.parentNode);d=e.attr("data-selected");"false"===d?(b=d3.rgb("hsl(211, 60%,"+100*a.v/255*.8+"%)"),c="true"):(b="rgb("+a.v+","+a.v+","+a.v+")",c="false");e.attr("data-selected",c);return b})};this.clickCallback=function(){selectCluster(parseInt(d3.select(this).attr("data-cluster")))}}
function clusterGraph(b,c,f){this.name=b;this.width=c;this.height=f;this.rasterValue=initialRaster;this.frameSizeY=this.frameSizeX=0;this.clusterData=null;this.create=function(){d3.select("#"+this.name).append("svg").attr("id",this.name+"-svg").attr("width",this.width).attr("height",this.height);d3.select("#"+this.name+"-svg").append("image").attr("id",this.name+"-img");d3.select("#"+this.name+"-svg").append("g").attr("id",this.name+"-rectGroup")};this.loadImage=function(a,e){var d=this;void 0===
e&&(e=this.rasterValue);this.image=new Image;this.image.onload=function(){var a=e;d.scaleX=d.width/d.frameSizeX;d.scaleY=d.height/d.frameSizeY;d.scaleStr="scale("+d.scaleX+","+d.scaleY+")";var b=d.image.width,c=d.image.height;d.gridSize=b/d.frameSizeX;d3.select("#"+d.name+"-img").attr("width",b).attr("height",c).attr("xlink:href",d.image.src).attr("transform",d.scaleStr);d.raster(a);d.drawOverlays(a)};this.image.src=a};this.raster=function(a){var e;e=this.scaleStr+" translate(-"+a%this.gridSize*this.frameSizeX+
",-"+this.frameSizeY*Math.floor(a/this.gridSize)+")";$("#"+this.name+"-img").attr("transform",e);this.rasterValue=a};this.drawOverlays=function(a){if(null!==this.clusterData){a=this.clusterData[a];var e=0,d=[],b=[],c=[],f=[],h,p;for(h=0;h<a.length;h++)b.push(a[h][0]),c.push(a[h][1]),d.push(e),e+=a[h][1];for(e=0;e<a.length;e++)for(h=0;h<a.length;h++)p={width:this.scaleX*c[h],height:this.scaleY*c[e],x:this.scaleX*d[h],y:this.scaleY*d[e],c1:b[e],c2:b[h],classes:"clusterOverlay CGunselected cluster"+
b[e]+" cluster"+b[h]},e===h&&(p.classes+=" diagonalCluster"),f.push(p);d3.select("#"+this.name+"-rectGroup").selectAll("rect").remove();d3.select("#"+this.name+"-rectGroup").selectAll("rect").data(f).enter().append("rect").attr("width",function(a){return a.width}).attr("height",function(a){return a.height}).attr("x",function(a){return a.x}).attr("y",function(a){return a.y}).attr("data-clusters",function(a){return[a.c1,a.c2]}).attr("class",function(a){return a.classes})}};this.clusterSelectDeselect=
function(a){a=d3.selectAll('[data-clusters="'+a+","+a+'"]');var e=a.classed("CGunselected");a.classed("CGunselected",!e);a.classed("CGselected",e)};this.clickCallback=function(){var a=$(this).attr("data-clusters").split(",");a[0]===a[1]&&selectCluster(parseInt(a[0]))};$("#"+this.name).on("click","rect",this.clickCallback)}
function eigenplot(b,c,f){this.where=b;this.width=c;this.height=f;this.margins={top:18,right:10,bottom:5,left:24};this.strokeColor="black";this.strokeWidth=1.5;this.data=null;this.setScales=function(){var a=this.data.map(function(a){return a.x}),e=this.data.map(function(a){return a.y});this.domainMin=Math.min.apply(null,a);this.domainMax=Math.max.apply(null,a);this.rangeMin=Math.min.apply(null,e);this.rangeMax=Math.max.apply(null,e);this.xScale=d3.scale.linear().range([this.margins.left,this.width-
this.margins.right]).domain([this.domainMin,this.domainMax]);this.yScale=d3.scale.linear().range([this.height-this.margins.top,this.margins.bottom]).domain([this.rangeMin,this.rangeMax]);this.lineFunc=d3.svg.line().interpolate("linear").x(function(a){return this.xScale(a.x)}).y(function(a){return this.yScale(a.y)})};this.create=function(){d3.select("#"+this.where).append("svg").attr("width",this.width).attr("height",this.height).attr("id",this.where+"-svg")};this.resetSVG=function(){d3.select("#"+
this.where+"-group").remove();d3.select("#"+this.where+"-svg").append("g").attr("id",this.where+"-group")};this.drawGrids=function(a){var e=d3.select("#"+this.where+"-group"),b=this;e.append("g").attr("id",a+"-verticalGrid");d3.select("#"+this.where+"-verticalGrid").selectAll(".gridlines").data(b.xScale.ticks()).enter().append("line").attr("class","gridlines").attr("x1",function(a){return b.xScale(a)}).attr("x2",function(a){return b.xScale(a)}).attr("y1",function(){return b.yScale(b.rangeMin)}).attr("y2",
function(){return b.yScale(b.rangeMax)});e.append("g").attr("id",this.where+"-horizontalGrid");d3.select("#"+this.where+"-horizontalGrid").selectAll(".gridlines").data(b.yScale.ticks(5)).enter().append("line").attr("class","gridlines").attr("x1",function(){return b.xScale(b.domainMin)}).attr("x2",function(){return b.xScale(b.domainMax)}).attr("y1",function(a){return b.yScale(a)}).attr("y2",function(a){return b.yScale(a)})};this.drawAxes=function(a,b){var d,g,c,f,h,p,v;d=d3.select("#"+this.where+"-group");
p=this.height-this.margins.top;v=this.margins.left;void 0===b&&(b={});g="nticksX"in b?d3.svg.axis().scale(this.xScale).orient("bottom").ticks(b.nticksX):d3.svg.axis().scale(this.xScale).orient("bottom").ticks(5);c="nticksY"in b?d3.svg.axis().scale(this.yScale).orient("left").ticks(b.nticksY):d3.svg.axis().scale(this.yScale).orient("left").ticks(5);h="yText"in b?b.yText:"Scaled eig. val.";f="xText"in b?b.xText:"Eig. val. #";d.append("g").attr("class","x plotaxis").attr("transform","translate(0,"+p+
")").call(g);d.append("g").attr("class","y plotaxis").attr("transform","translate("+v+",0)").call(c);d.append("text").attr("y",this.height-this.margins.top-5).attr("x",this.width-this.margins.right-4).attr("font-size",12).style("text-anchor","end").text(f);d.append("text").attr("transform","rotate(-90)").attr("y",this.margins.right+28).attr("x",-5).attr("dy",".05em").attr("font-size","12").style("text-anchor","end").text(h)};this.redraw=function(a){this.resetSVG(this.where);this.drawGrids(this.where);
this.drawAxes(this.where,a)};this._sliderStartAction=function(){deselectAllClusters()};this._sliderDragAction=function(){var a,b;a=d3.select("#"+this.where+"-slider");b=parseFloat(a.attr("data-x"))+d3.event.dx;b<this.margins.left&&(b=this.margins.left);b>this.width-this.margins.right&&(b=this.width-this.margins.right);a.attr("data-x",b);a.attr("transform","translate("+b+",0)");a=Math.floor(this.xScale.invert(b))-1;gui.blocks.raster(a);gui.som.outline(a)};this._sliderEndAction=function(){var a,b,d,
c;a=d3.select("#"+this.where+"-slider");b=parseFloat(a.attr("data-x"));b=Math.floor(this.xScale.invert(b));d=this.xScale(b);0<b&&(c=function(a,b,e){return d3.interpolateString(e,"translate("+d+",0)")},a.transition().duration(100).delay(0).attrTween("transform",c),gui.blocks.drawOverlays(b-1),gui.som.assignClusters(b-1))};this.replot=function(a,b){function d(){var a;try{a=b.color}catch(d){a=g.strokeColor}return a}var g=this,f,l;l=d3.select("#"+this.where+"-group");l.select("#"+this.where+"-plot").remove();
l.append("g").attr("id",this.where+"-plot");d3.select("#"+g.where+"-plot").selectAll(".selecter").data([g.data]).enter().append("path").attr("d",function(a){return g.lineFunc(a)}).attr("fill","none").attr("stroke",d()).attr("stroke-width",function(){try{c=b.width}catch(a){c=g.strokeWidth}return c}());d3.select("#"+g.where+"-plot").selectAll("circle").data(g.data).enter().append("circle").attr("cx",function(a){return g.xScale(a.x)}).attr("cy",function(a){return g.yScale(a.y)}).attr("r",2).attr("fill",
flickrPink).attr("stroke",d()).attr("stroke-width",1);f=d3.behavior.drag().origin(function(){return{x:d3.select(this).attr("data-x"),y:0}}).on("dragstart",function(){gui.locks.canDrag&&g._sliderStartAction()}).on("drag",function(){gui.locks.canDrag&&g._sliderDragAction(this.id)}).on("dragend",function(){gui.locks.canDrag&&g._sliderEndAction(this.id)});l.append("g").attr("id",this.where+"-slider").attr("data-x",this.xScale(initialRaster+1)).attr("transform","translate("+this.xScale(initialRaster+1)+
",0)").call(f);d3.select("#"+this.where+"-slider").selectAll(".line").data([0]).enter().append("line").classed("slider",!0).attr("x1",function(a){return a}).attr("x2",function(a){return a}).attr("y1",function(){return g.yScale(g.rangeMin)}).attr("y2",function(){return g.yScale(g.rangeMax)}).attr("stroke",flickrBlue).attr("stroke-width",2);f=[g.rangeMin,g.rangeMax];d3.select("#"+this.where+"-slider").selectAll("circle").data(f).enter().append("circle").classed("slider",!0).attr("cx",0).attr("cy",function(a){return g.yScale(a)}).attr("r",
4.5).attr("fill",flickrBlue)}}
function photoMatrix(b,c,f){this.where=b;this.rows=c;this.cols=f;this.urls=[];this.dummy="static/images/placeholder.png";this.currentStart=0;this.create=function(){var a="",b,d=this;for(b=0;b<this.rows;b++)a=a+'<div class="thumbnail_row" id="thumbnail_row_'+b+'"></div>';$("#"+this.where).append(a+'<div id="scrollarrows"><img id="scrolldown" class="scrollinactive" src="static/images/downarrow.png"><img id="scrollup" class="scrollinactive" src="static/images/uparrow.png"></div>');$("#scrolldown").click(function(){d.scroll("down")});
$("#scrollup").click(function(){d.scroll("up")})};this.scroll=function(a){"down"===a&&this.urls.length-this.currentStart>this.rows*this.cols&&this.redraw(this.currentStart+this.rows*this.cols);"up"===a&&this.currentStart>=this.rows*this.cols&&this.redraw(this.currentStart-this.rows*this.cols)};this.redraw=function(a){var b,d,c,f,l=[],h='<div class="thumbnail_element"><a href="URL" target="_blank"><img src="SOURCE" width="150" height="150">'+"</a></div>".replace("USER",gui.data.nsid);d3.selectAll(".thumbnail_element").remove();
this.urls=gui.data.selectedPhotoThumbs;this.links=gui.data.selectedPhotoLinks;b=Math.min(this.urls.length-a,this.rows*this.cols);d=Math.ceil(b/this.cols);for(c=0;c<d;c++)l.push("");for(f=0;f<b;)c=Math.floor(f/this.cols),l[c]+=h.replace(/SOURCE/g,this.urls[f+a]).replace(/URL/g,this.links[f+a]),f+=1;for(c=0;c<d;c++)b=$("#thumbnail_row_"+c),b.append(),$("#thumbnail_row_"+c).append(l[c]),$("#thumbnail_row_"+c).css("width",152*b[0].children.length).css("height",152);for(c=d;c<this.rows;c++)$("#thumbnail_row_"+
c).css("height",0);this.currentStart=a;this.currentStart>=this.rows*this.cols?(d3.select("#scrollup").classed("scrollactive",!0),d3.select("#scrollup").classed("scrollinactive",!1)):(d3.select("#scrollup").classed("scrollactive",!1),d3.select("#scrollup").classed("scrollinactive",!0));this.urls.length-this.currentStart>this.rows*this.cols?(d3.select("#scrolldown").classed("scrollactive",!0),d3.select("#scrolldown").classed("scrollinactive",!1)):(d3.select("#scrolldown").classed("scrollactive",!1),
d3.select("#scrolldown").classed("scrollinactive",!0))}}
function selectCluster(b){if(gui.locks.canClick){var c=[],f,a=gui.data.selectedClusters.indexOf(b);b=parseInt(b);for(f=0;f<gui.data.members[b].length;f++)c.push(gui.data.tags[gui.data.members[b][f]]);if(-1<a){gui.data.selectedClusters.splice(a,1);for(a=0;a<c.length;a++)-1<gui.data.selectedTags.indexOf(c[a])&&selectTag(c[a],!0);gui.data.selectedPhotoIds=intersection(gui.data.selectedTags,gui.data.tagsToPhotos)||{};gui.photocounter.update();gui.photoMatrix.redraw(0)}else gui.data.selectedClusters.push(b);gui.som.clusterSelectDeselect(b);
gui.blocks.clusterSelectDeselect(b);gui.wordcloud.clusterSelectDeselect(b)}}
function selectTag(b,c){if(gui.locks.canChangeTags){var f,a;void 0===c&&(c=!1);f=gui.data.selectedTags.indexOf(b);-1<f?gui.data.selectedTags.splice(f,1):gui.data.selectedTags.push(b);a=d3.select("#wordcloud-"+b);-1<f?a.style("fill",a.attr("data-fill")):a.style("fill","orange");a.classed("selected",!a.classed("selected"));c||(gui.data.selectedPhotoIds=intersection(gui.data.selectedTags,gui.data.tagsToPhotos)||{},gui.photocounter.update(),gui.photoMatrix.redraw(0))}}
function deselectAllClusters(){var b;gui.locks.canDrag=!1;for(b=0;b<gui.data.selectedClusters.length;b++)gui.som.clusterSelectDeselect(gui.data.selectedClusters[b]),gui.blocks.clusterSelectDeselect(gui.data.selectedClusters[b]);d3.select("#"+gui.blocks.name+"-rectGroup").selectAll("rect").remove();gui.data.selectedClusters=[];gui.data.selectedTags=[];gui.data.selectedPhotoIds={};gui.wordcloud.clusterSelectDeselect();gui.photoMatrix.redraw(0);gui.locks.canDrag=!0}
function buildTable(){for(var b="",c="",f="",a="",a=0;a<sequence.length;a++)b+='<td colspan="3">CAPTION</td>'.replace(/CAPTION/g,sequence[a].caption[0]),c+='<td class="crhr"></td><td><div class="indicator" id="LABEL"></div></td><td class="crhr"></td>'.replace(/LABEL/g,sequence[a].label),f+='<td colspan="3">CAPTION</td>'.replace(/CAPTION/g,sequence[a].caption[1]);a="<table>"+('<tr class="textrow">'+b+"</tr>")+('<tr class="circlerow">'+c+"</tr>")+('<tr class="textrow">'+f+"</tr>")+"</table>";$("#progress2").append(a);
$(".crhr").css("width",100)}function intersection(b,c){var f,a;a=c[b[0]];for(f=1;f<b.length;f++){var e=a,d=c[b[f]],g=void 0;a={};for(g in e)d.hasOwnProperty(g)&&(a[g]=null)}return a}function union(b){var c={},f,a;for(f=0;f<b.length;f++)for(a in gui.data.tagsToPhotos[b[f]])c[a]=1;return c}
function resetAndGo(){gui.data={};gui.locks={canDrag:!0,canClick:!0,canChangeTags:!0};gui.data.selectedClusters=[];gui.data.selectedTags=[];gui.data.photosForTags={};gui.data.selectedPhotoIds={};sequenceCount=0;nextStage()}$(document).ready(function(){buildTable();$("#flickruser").submit(function(){event.preventDefault();$(".indicator").css("background-color","inherit");$("#progress2").slideDown(200,resetAndGo)})});